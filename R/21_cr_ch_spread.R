# ---- generator_function ----
gen_cr_ch_model <- function(lower, upper, step, min_hr_until_aki, max_hr_until_aki) {
  cr_ch_steps = seq(lower, upper, by = step)
  cr_ch_steps_df = data.frame(
    lower_hr_del_t_ch = head(cr_ch_steps, -1),
    upper_hr_del_t_ch = tail(cr_ch_steps, -1),
    min_hr_until_aki  = min_hr_until_aki,
    max_hr_until_aki  = max_hr_until_aki
  ) %>%
    mutate(del_t_ch_range = paste0("[", lower_hr_del_t_ch, ", ", upper_hr_del_t_ch, "]")) %>%
    rowwise() %>%
    do(data.frame(., cr_ch_model(
      c(.$lower_hr_del_t_ch, .$upper_hr_del_t_ch), c(.$min_hr_until_aki, .$max_hr_until_aki)))
    ) %>%
    ungroup()
  cr_ch_steps_df$del_t_ch_range <- factor(
    cr_ch_steps_df$del_t_ch_range, levels = cr_ch_steps_df$del_t_ch_range)

  return(cr_ch_steps_df)
}

# ---- Example_1hr_incr_spread ----
n_admin_total = round(length(unique(logit_df$AdmissionID))/100, 0)*100

cr_ch_steps = gen_cr_ch_model(
  lower = 0,
  upper = 20,
  step = 1,
  min_hr_until_aki = 8,
  max_hr_until_aki = 16
) %>%
  select(-sensitivity:-optimal_cutpoint) %>%
  mutate(heuristic = (AUC*1.1 + per_admin_in)/2.1) %>%
  pivot_longer(cols = c(AUC, per_admin_in), names_to = "names", values_to = "values") %>%
  mutate(
    labels = if_else(names == "AUC", round(values, 2), round(values*n_admin_total, 0)),
    names  = if_else(names == "AUC", "AUC", "Admissions"),
    names  = factor(names, levels = c("AUC", "Admissions"))
  )

ggplot(cr_ch_steps, aes(x = del_t_ch_range, y = values, fill = names, colour = names)) +
  geom_col(position = "dodge", alpha = 0.5, colour = NA) +
  geom_label(
    aes(label = labels),
    position = position_dodge(0.9), vjust = -0.2, fill = "white",
    show.legend = FALSE
  ) +
  geom_point(position = position_dodge(0.9)) +
  geom_point(
    aes(x = del_t_ch_range, y = heuristic, fill = "Heuristic", colour = "Heuristic"),
    data = cr_ch_steps %>% filter(names == "AUC"),
  ) +
  scale_y_continuous(
    limits = c(0, 0.95),
    breaks = seq(0, 0.9, by = 0.2),
    sec.axis = sec_axis(
      trans = ~.*n_admin_total,
      name = "Number of Included Admissions",
      breaks = seq(0, 0.9, by = 0.2)*n_admin_total)
  ) +
  ggtitle("AUC and Number of Admissions for Various \u0394t Increments") +
  xlab(expression("Duration of small change in Cr epis: "*Delta*"t"["cr_ch"]*" (hours)")) +
  ylab("AUC") +
  scale_fill_manual(name = "Legend", values=c("orange","blue", "black")) +
  scale_colour_manual(name = "Legend", values=c("orange","blue", "black")) +
  theme(legend.position="bottom")

# ---- next ----


plot_cr_ch = expand.grid(seq(0, 30, by = 0.1), seq(0, 3, by = 0.1)) %>%
  rename(centre = Var1, tol = Var2) %>%
  mutate(
    lower = centre - tol,
    upper = centre + tol) %>%
  filter(upper > lower, lower > 0) %>%
  rowwise() %>%
  do(data.frame(., cr_ch_model(.$lower, .$upper, 12))) %>%
  ungroup()

# Consider parallising above^
# cluster <- new_cluster(4)
# cluster_assign(cluster, logit_df = logit_df, cr_ch_model = cr_ch_model)
# partition(cluster)

head(plot_cr_ch %>% arrange(desc(heuristic), desc(AUC)))
head(plot_cr_ch %>% mutate(heuristic = (AUC*3 + (n_admissions/313))) %>% arrange(desc(heuristic), desc(AUC)), 20)

ggplot(plot_cr_ch %>% filter(AUC > 0), aes(centre, tol, fill = AUC)) +
  geom_tile() +
  geom_contour(aes(z = AUC, colour = after_stat(level)),
               binwidth = 0.01) + #, colour = after_stat(level))) +
  coord_fixed() +
  scale_fill_viridis_c() +
  scale_colour_viridis_c()

ggplot(plot_cr_ch %>% filter(AUC > 0), aes(centre, tol, fill = heuristic)) +
  geom_tile() +
  geom_contour(aes(z = heuristic), colour = "white", binwidth = 0.025) + #, colour = after_stat(level))) +
  coord_fixed() +
  scale_fill_viridis_c() +
  scale_colour_viridis_c()

ggplot(plot_cr_ch %>% filter(AUC > 0), aes(centre, tol, fill = n_admissions)) +
  geom_tile() +
  geom_contour(aes(z = n_admissions), colour = "white", binwidth = 20) + #, colour = after_stat(level))) +
  geom_text_contour(aes(z = n_admissions), colour = "white") +
  coord_fixed() +
  scale_fill_viridis_c() +
  scale_colour_viridis_c()

ggplot(plot_cr_ch %>% filter(AUC > 0), aes(centre, tol)) +
  geom_tile(aes(fill = AUC)) +
  geom_contour(aes(z = n_admissions), colour = "white", binwidth = 20) + #, colour = after_stat(level))) +
  geom_text_contour(aes(z = n_admissions), colour = "white") +
  # geom_text_contour(aes(z = AUC), colour = "white") +
  coord_fixed() +
  scale_fill_viridis_c() +
  scale_colour_viridis_c()

# ---- optimisation ----
optim(
  c(10, 11),
  function(x) -cr_ch_model(x[1], x[2], 12)$heuristic,
  lower = c(0, 0),
  upper = c(200, 200),
  method = "L-BFGS-B"
)
